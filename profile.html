<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Profile - Rebelvids Academy</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="loading">
  <div id="page-loader"><div class="spinner"></div></div>
  <header class="topbar fixed">
    <div class="container header-inner">
      <!-- Mobile back button (visible only on mobile) -->
      <a class="mobile-back-btn" href="index.html" id="back-btn-mobile-header">← Back</a>
      
      <div class="logo-small"><a href="index.html">Rebelvids Academy</a></div>
      <div class="nav-capsule">
        <nav class="nav">
          <a href="index.html">Home</a>
          <a href="shop.html">Shop</a>
          <a href="courses.html">Courses</a>
          <a href="bundle.html">Bundles</a>
        </nav>
      </div>
      <div class="header-cta">
        <a class="cta-pill" href="index.html" id="back-btn-desktop">Back</a>
      </div>

      <!-- Mobile nav toggle -->
      <button class="nav-toggle" aria-expanded="false" aria-label="Open menu" id="mobile-menu-toggle">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </button>

      <div class="mobile-nav" aria-hidden="true">
        <nav>
          <a href="index.html">Home</a>
          <a href="shop.html">Shop</a>
          <a href="courses.html">Courses</a>
          <a href="bundle.html">Bundles</a>
        </nav>
      </div>
    </div>
  </header>
  
  <style>
    /* Mobile back button styles - visible only on mobile */
    .mobile-back-btn {
      display: none;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, #0b78ff, #00a6ff);
      color: #02141a;
      text-decoration: none;
      font-weight: 800;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(11, 97, 255, 0.18);
      margin-right: 8px;
    }
    
    @media (max-width: 425px) {
      .mobile-back-btn {
        display: inline-flex;
      }
      .header-cta {
        display: none;
      }
    }
  </style>

  <main class="page">
    <div class="container">
      <h1 class="section-title">Your Profile</h1>
      <div id="profile-box" class="compare-card" style="padding:20px">
        <div id="profile-content">Loading...</div>
      </div>
    </div>
  </main>
  <script>
    (function(){
      var start = (window.performance && performance.now) ? performance.now() : Date.now();
      var MIN = 1200;
      function reallyHide(){ document.body.classList.remove('loading'); var l=document.getElementById('page-loader'); if(l){ setTimeout(function(){ l.style.display='none'; },320);} }
      function hideWithMinimum(){ var now=(window.performance&&performance.now)?performance.now():Date.now(); var delta=now-start; setTimeout(reallyHide, Math.max(0, MIN-delta)); }
      if(document.readyState==='complete') hideWithMinimum(); else window.addEventListener('load', hideWithMinimum);
      var sels=['.section-title','#profile-box','#profile-content'];
      sels.forEach(function(s){ document.querySelectorAll(s).forEach(function(el,i){ if(!el.hasAttribute('data-reveal')){ el.setAttribute('data-reveal','fade-up'); el.style.setProperty('--reveal-delay',(i*80)+'ms'); } }); });
      if('IntersectionObserver' in window){ var obs=new IntersectionObserver(function(es){ es.forEach(function(e){ if(e.isIntersecting){ e.target.classList.add('is-visible'); obs.unobserve(e.target);} }); },{threshold:0.2,rootMargin:'0px 0px -10% 0px'}); document.querySelectorAll('[data-reveal]').forEach(function(el){ obs.observe(el); }); } else { document.querySelectorAll('[data-reveal]').forEach(function(el){ el.classList.add('is-visible'); }); }
    })();
  </script>

  <script>
    // Mobile nav toggle functionality
    document.addEventListener('DOMContentLoaded', function(){
      const toggle = document.getElementById('mobile-menu-toggle');
      const mobileNav = document.querySelector('.mobile-nav');
      if(toggle && mobileNav){
        function setOpen(open){
          toggle.classList.toggle('open', open);
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
          mobileNav.setAttribute('aria-hidden', open ? 'false' : 'true');
        }
        toggle.addEventListener('click', ()=>{
          const isOpen = toggle.classList.contains('open');
          setOpen(!isOpen);
        });
        mobileNav.querySelectorAll('a').forEach(a=>a.addEventListener('click', ()=>setOpen(false)));
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') setOpen(false) });
      }

      // Back button functionality - use history.back() if available, else go to index.html
      function goBack(e){
        e.preventDefault();
        if(window.history.length > 1){
          window.history.back();
        } else {
          window.location.href = 'index.html';
        }
      }

      const backBtnDesktop = document.getElementById('back-btn-desktop');
      const backBtnMobileHeader = document.getElementById('back-btn-mobile-header');
      
      if(backBtnDesktop) backBtnDesktop.addEventListener('click', goBack);
      if(backBtnMobileHeader) backBtnMobileHeader.addEventListener('click', goBack);
    });

    (function(){
      const USERS_KEY='rva_users';
      const SESSION_KEY='rva_session';
      function getUsers(){ try{return JSON.parse(localStorage.getItem(USERS_KEY)||'[]')}catch(e){return[]} }
      function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
      function getSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch(e){return null} }
      const session = getSession();
      const users = getUsers();
      const me = users.find(u=>u.id===session);
      const box = document.getElementById('profile-content');
      if(!me){ box.innerHTML = '<p style="color:var(--muted)">You are not logged in. <a href="index.html">Go to home and login</a></p>'; return; }

      function render(){
        // load helper data
        let items = [];
        try{ items = JSON.parse(localStorage.getItem('rva_items')||'[]'); }catch(e){ items = [] }
        let cart = [];
        try{ cart = JSON.parse(localStorage.getItem('rva_cart')||'[]'); }catch(e){ cart = [] }

        const myCart = cart.filter(c=>c.userId===me.id);
        const userCartCount = myCart.reduce((s,i)=>s+(i.qty||1),0) || 0;

        // purchases: load from Firebase orders for this user
        const DB_URL = 'https://rebelvids-academy-default-rtdb.firebaseio.com';

        box.innerHTML = `
          <h3>${me.name}</h3>
          <p style="color:var(--muted)">${me.email}</p>
          <p style="margin-top:12px">Products in cart: <strong id="cart-count">${userCartCount}</strong></p>
          <p>Total purchases: <strong id="purchase-count">${me.purchases||0}</strong></p>

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
            <label style="flex:1">Edit name<input id="edit-name" type="text" value="${me.name}" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"></label>
            <button id="save-name" class="primary-btn">Save</button>
          </div>

          <div style="margin-top:18px">
            <h4>Your Cart Items</h4>
            <div id="cart-list" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:18px">
            <h4>Your Purchases</h4>
            <div id="purchase-list" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px">
            <button id="logout" class="ghost-btn">Logout</button>
            <button id="clear-cart" class="btn-clear">Clear My Cart</button>
          </div>
        `;

        // render cart items
        const cartList = document.getElementById('cart-list');
        if(myCart.length===0) cartList.innerHTML = '<p style="color:var(--muted)">No items in your cart.</p>';
        else{
          cartList.innerHTML = myCart.map(c=>{
            const ref = items.find(i=>i.id===c.id) || {};
            return `<div class="cart-item" data-id="${c.id}" style="display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px">
              <img src="${c.image||ref.image||'assets/logo-placeholder.png'}" style="width:64px;height:48px;object-fit:cover;border-radius:6px;flex-shrink:0">
              <div style="flex:1"><strong>${c.title||ref.title||'Untitled'}</strong><div style="color:var(--muted)">Qty: ${c.qty||1} • ₹${c.price||'0'}</div></div>
              <button data-id="${c.id}" class="ghost-btn remove-cart">Remove</button>
            </div>`;
          }).join('');

          // attach remove handlers
          cartList.querySelectorAll('.remove-cart').forEach(btn=> btn.addEventListener('click', function(){
            const id = this.dataset.id;
            let allCart = [];
            try{ allCart = JSON.parse(localStorage.getItem('rva_cart')||'[]'); }catch(e){ allCart = [] }
            allCart = allCart.filter(x=> !(x.id===id && x.userId===me.id) );
            localStorage.setItem('rva_cart', JSON.stringify(allCart));
            render();
          }));

          // delegate navigation on cart item click (ignore clicks on Remove button)
          cartList.onclick = function(e){
            const removeBtn = e.target.closest && e.target.closest('.remove-cart');
            if(removeBtn) return;
            const item = e.target.closest && e.target.closest('.cart-item');
            if(!item) return;
            const pid = item.getAttribute('data-id');
            if(pid){ window.location.href = `product-details.html?id=${pid}`; }
          };
        }

        // render purchases from Firebase
        const purchaseList = document.getElementById('purchase-list');
        (async function(){
          try{
            const [ordersRes, productsRes] = await Promise.all([
              fetch(`${DB_URL}/orders.json`),
              items.length ? Promise.resolve({ ok:true, json: async()=>Object.fromEntries(items.map(p=>[p.id, p])) }) : fetch(`${DB_URL}/products.json`)
            ]);
            if(!ordersRes.ok) { purchaseList.innerHTML = '<p style="color:var(--muted)">No purchases yet.</p>'; return; }
            const ordersData = await ordersRes.json();
            const productsData = await productsRes.json();
            const orders = ordersData && typeof ordersData==='object' ? Object.keys(ordersData).map(k=>({ id:k, ...ordersData[k] })) : [];
            const myOrders = orders.filter(o=> o && (o.userId===me.id || o.userID===me.id));
            if(!myOrders.length){ purchaseList.innerHTML = '<p style="color:var(--muted)">No purchases yet.</p>'; document.getElementById('purchase-count').textContent = '0'; return; }
            const productMap = productsData && typeof productsData==='object' ? productsData : {};
            const rows = myOrders.map(o=>{
              const prod = productMap[o.productId] || items.find(x=>x.id===o.productId) || {};
              const title = o.productTitle || prod.title || 'Purchased Item';
              const image = (prod && prod.image) || 'assets/logo-placeholder.png';
              const price = o.amount || prod.price || '0';
              const link = o.downloadLink || prod.link || prod.buyLink || '#';
              const safeLink = link && typeof link==='string' ? link : '#';
              return `<div class="purchase-item" data-id="${o.productId||''}" style="display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px">
                <img src="${image}" style="width:64px;height:48px;object-fit:cover;border-radius:6px;flex-shrink:0">
                <div style="flex:1">
                  <strong>${title}</strong>
                  <div style="color:var(--muted)">₹${price}</div>
                  <div style="margin-top:6px"><a href="${safeLink}" target="_blank" rel="noopener" class="secondary-btn" style="padding:6px 10px;border-radius:10px">Download again</a></div>
                </div>
              </div>`;
            }).join('');
            purchaseList.innerHTML = rows;
            document.getElementById('purchase-count').textContent = String(myOrders.length);
          }catch(e){
            purchaseList.innerHTML = '<p style="color:var(--muted)">No purchases yet.</p>';
            document.getElementById('purchase-count').textContent = '0';
          }
        })();

        // save name
        document.getElementById('save-name').addEventListener('click', function(){
          const v = document.getElementById('edit-name').value.trim();
          if(!v) return alert('Name cannot be empty');
          me.name = v;
          const all = getUsers();
          const idx = all.findIndex(u=>u.id===me.id);
          if(idx>-1){ all[idx]=me; saveUsers(all); alert('Name saved'); document.querySelector('.logo-small a').textContent = me.name; }
          render();
        });

        document.getElementById('logout').addEventListener('click', function(){
          localStorage.removeItem(SESSION_KEY);
          window.location.href = 'index.html';
        });

        document.getElementById('clear-cart').addEventListener('click', function(){
          let allCart = [];
          try{ allCart = JSON.parse(localStorage.getItem('rva_cart')||'[]'); }catch(e){ allCart = [] }
          allCart = allCart.filter(x=> x.userId!==me.id );
          localStorage.setItem('rva_cart', JSON.stringify(allCart));
          render();
        });
      }

      render();
    })();
  </script>
</body>
</html>
